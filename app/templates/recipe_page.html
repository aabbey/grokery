{% extends 'base.html' %}
{% load static %}

{% block title %}Groc - Recipes & Grocery List{% endblock %}

{% block content %}
<div class="centered-layout">
    <div class="container">
        <header>
            <a href="/" class="back-arrow">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1>Your Recipes</h1>
            <a href="#" class="settings">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20v-8M12 8V4M6 20v-4M6 12V4M18 20V12M18 8V4"/>
                </svg>
            </a>
        </header>

        <main class="split-layout">
            <aside class="grocery-list-sidebar">
                <div class="grocery-list" id="groceryList">
                    <h2>Grocery List</h2>
                    <div id="groceryListLoading">
                        <div class="recipe-item loading">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Creating grocery list...</p>
                        </div>
                    </div>
                    <ul id="groceryListContent" class="content-hidden">
                        <!-- Content will be loaded dynamically -->
                    </ul>
                </div>
            </aside>
            
            <section class="recipes-section">
                <div class="recipes">
                    <div id="recipesLoading">
                        <div class="recipe-item loading">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Making recipe...</p>
                        </div>
                        <div class="recipe-item loading">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Making recipe...</p>
                        </div>
                    </div>
                    <div id="recipesContent" class="content-hidden">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>
            </section>
        </main>

        <div class="grocery-overlay" id="groceryOverlay">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to create recipe template HTML (minimal version)
    function createRecipeTemplateHTML(recipe) {
        return `
            <a href="#" class="recipe-item">
                <div class="recipe-info">
                    <h3>${recipe.title}</h3>
                    <p>${recipe.description}</p>
                </div>
                <div class="recipe-loading">Loading details...</div>
            </a>
        `;
    }

    // Function to create detailed recipe HTML
    function createDetailedRecipeHTML(recipe) {
        const ingredientsList = recipe.ingredients.map(ing => 
            `<li>${ing.quantity} ${ing.unit} ${ing.name}</li>`
        ).join('');

        const instructions = recipe.instructions.map(step => 
            `<li>${step}</li>`
        ).join('');

        return `
            <a href="#" class="recipe-item">
                <div class="recipe-info">
                    <h3>${recipe.title}</h3>
                    <p>${recipe.description}</p>
                    <div class="recipe-details">
                        <h4>Ingredients:</h4>
                        <ul>${ingredientsList}</ul>
                        <h4>Instructions:</h4>
                        <ol>${instructions}</ol>
                    </div>
                </div>
                <div class="recipe-options">â‹®</div>
            </a>
        `;
    }

    // Function to create grocery item HTML
    function createGroceryItemHTML(item) {
        return `<li>${item.name} - ${item.quantity} ${item.unit}</li>`;
    }

    // Load content from API with staged loading
    fetch('/api/recipe-data/')
        .then(response => response.json())
        .then(data => {
            // Update recipes with templates first
            const recipesContent = document.getElementById('recipesContent');
            recipesContent.innerHTML = data.recipes.map(recipe => createRecipeTemplateHTML(recipe)).join('');
            recipesContent.classList.remove('content-hidden');
            document.getElementById('recipesLoading').style.display = 'none';

            if (data.status === 'complete') {
                // Update with detailed recipes
                recipesContent.innerHTML = data.recipes.map(recipe => createDetailedRecipeHTML(recipe)).join('');
                
                // Update grocery list
                const groceryListContent = document.getElementById('groceryListContent');
                groceryListContent.innerHTML = data.grocery_list.map(item => createGroceryItemHTML(item)).join('');
                groceryListContent.classList.remove('content-hidden');
                document.getElementById('groceryListLoading').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            // Show error message to user
            document.getElementById('recipesLoading').innerHTML = `
                <div class="recipe-item loading">
                    <p class="loading-text" style="color: #e74c3c;">Error loading recipes. Please try again later.</p>
                </div>
            `;
            document.getElementById('groceryListLoading').innerHTML = `
                <div class="recipe-item loading">
                    <p class="loading-text" style="color: #e74c3c;">Error loading grocery list. Please try again later.</p>
                </div>
            `;
        });
});
</script>
{% endblock %}
